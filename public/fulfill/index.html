<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>ChicCanto Fulfillment</title>
<link href="/assets/css/base.css" rel="stylesheet"/>
</head>
<body data-page="fulfill">
<header class="site-header">
<div class="site-header__inner">
<a class="brand" href="/fulfill/"><img alt="ChicCanto" class="brand__logo" src="/assets/img/logo1.svg"/></a>
<div class="site-actions">
<button class="btn outline sm" id="logoutBtn" type="button">Log out</button>
</div>
</div>
</header>
<main class="page-main">
<div class="container flow-layout">
<div class="flow-intro fulfill-hero">
<div>
<div class="kicker">FULFILLMENT</div>
<h1>Operator console, simplified</h1>
<p class="lead">Assign an activation code, then copy the Etsy message with direct link included.</p>
</div>
</div>
<div class="panel-kicker">ASSIGN CARD</div>
<section class="flow-panel fulfill-panel fulfill-panel--assign">
<div class="panel-meta"><span>Step 1 - Card setup</span><span>Assign code</span></div>
<div class="stack">
<div class="field">
<label class="sr-only" for="orderId">Etsy order number</label>
<input class="input" id="orderId" inputmode="text" placeholder="Etsy order number" type="text"/>
</div>
<div class="fulfill-grid-2">
<div class="field">
<label class="sr-only" for="cardKey">Card type</label>
<select aria-hidden="true" aria-label="Card type" class="select native-select" id="cardKey" tabindex="-1"><option disabled="disabled" selected="selected" value="">Select card type</option>
<option value="men-novice1">Men card (standard)</option>
<option value="men-novice-birthday1">Men card (birthday)</option>
</select><div class="cselect" data-placeholder="Select card type" data-require="true" data-select="#cardKey"><button aria-expanded="false" aria-haspopup="listbox" class="cselect__btn" type="button"><span class="cselect__value"></span><span aria-hidden="true" class="cselect__chev">▾</span></button><div class="cselect__menu" role="listbox" tabindex="-1"></div></div>
</div>
<div class="field">
<label class="sr-only" for="quantity">Quantity</label>
<select aria-hidden="true" aria-label="Quantity" class="select native-select" id="quantity" tabindex="-1">
<option selected="selected" value="1">1 card</option>
<option value="4">Full set (4 cards)</option>
</select><div class="cselect" data-placeholder="1 card" data-select="#quantity"><button aria-expanded="false" aria-haspopup="listbox" class="cselect__btn" type="button"><span class="cselect__value"></span><span aria-hidden="true" class="cselect__chev">▾</span></button><div class="cselect__menu" role="listbox" tabindex="-1"></div></div>
</div>
</div>
<div class="field">
<label class="sr-only" for="buyerName">Buyer name (optional)</label>
<input class="input" id="buyerName" inputmode="text" placeholder="Buyer name (optional)" type="text"/>
</div>
<button class="btn outline full" id="assignBtn" type="button">Assign code</button>
<div class="fulfill-feedback">
<p aria-live="polite" class="muted" id="status"></p>
<div class="fulfill-code-preview">
<label class="sr-only" for="assignedCode">Assigned code</label>
<input class="input" id="assignedCode" placeholder="Assigned code" readonly="" type="text"/>
</div>
</div>
</div>
</section>
<div class="panel-kicker">PASTE TO ETSY</div>
<section class="flow-panel fulfill-panel fulfill-panel--message">
<div class="panel-meta"><span>Step 2 - Paste to Etsy message</span><span>Copy and send</span></div>
<div class="stack">
<div class="row between fulfill-message-head">
<div>
<h2 class="h2 no-m">Etsy message preview</h2>
</div>
<button class="btn outline" disabled="" id="copyBtn" type="button">Copy</button>
</div>
<div class="field">
<label class="sr-only" for="message">Message</label>
<textarea class="textarea fulfill-message-box" id="message" placeholder="Your filled message will appear here" readonly=""></textarea>
</div>
<p class="footnote">If something looks wrong, do not guess. Re-run with the same order number and you should get the same code.</p>
</div>
</section>
</div>
</main>
<script src="/assets/js/app.js" type="module"></script>
<script>(function () {
  function initCustomSelect(root) {
    const sel = document.querySelector(root.dataset.select);
    if (!sel) return;

    const btn = root.querySelector('.cselect__btn');
    const valEl = root.querySelector('.cselect__value');
    const menu = root.querySelector('.cselect__menu');

    const required = root.dataset.require === 'true';
    const placeholder = root.dataset.placeholder || '';

    // Build menu from native select options (exclude empty + disabled placeholders)
    const opts = Array.from(sel.options).filter(o => {
      const v = (o.value || '').trim();
      if (!v) return false;
      if (o.disabled) return false;
      return true;
    });
    if (!opts.length) return;

    // For required selects, keep empty value until user picks.
    // For non-required selects, default to first option if empty.
    if (!required && !sel.value) sel.value = opts[0].value;

    function renderMenu() {
      menu.innerHTML = '';
      opts.forEach((o) => {
        const item = document.createElement('button');
        item.type = 'button';
        item.className = 'cselect__opt';
        item.setAttribute('role', 'option');
        item.dataset.value = o.value;
        item.textContent = o.textContent;
        item.setAttribute('aria-selected', o.value === sel.value ? 'true' : 'false');
        item.addEventListener('click', () => {
          setValue(o.value);
          close();
          btn.focus();
        });
        menu.appendChild(item);
      });
    }

    function syncLabel() {
      if (required && !sel.value) {
        valEl.textContent = placeholder || 'Select…';
        root.classList.add('is-empty');
      } else {
        const selected = opts.find(o => o.value === sel.value) || opts[0];
        valEl.textContent = selected.textContent;
        root.classList.remove('is-empty');
      }
      Array.from(menu.querySelectorAll('.cselect__opt')).forEach((n) => {
        n.setAttribute('aria-selected', n.dataset.value === sel.value ? 'true' : 'false');
      });
    }

    function setValue(v) {
      if (sel.value === v) return;
      sel.value = v;
      sel.dispatchEvent(new Event('change', { bubbles: true }));
      syncLabel();
    }

    function open() {
      root.classList.add('is-open');
      btn.setAttribute('aria-expanded', 'true');
      renderMenu();
      syncLabel();

      // Avoid initial highlight when required+empty: focus menu container first.
      if (required && !sel.value) {
        menu.focus();
        return;
      }

      const current = menu.querySelector('.cselect__opt[aria-selected="true"]') || menu.querySelector('.cselect__opt');
      current && current.focus();
    }

    function close() {
      root.classList.remove('is-open');
      btn.setAttribute('aria-expanded', 'false');
    }

    function toggle() {
      if (root.classList.contains('is-open')) close();
      else open();
    }

    // Initial render
    renderMenu();
    syncLabel();

    btn.addEventListener('click', toggle);

    btn.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        open();
      }
    });

    menu.addEventListener('keydown', (e) => {
      const items = Array.from(menu.querySelectorAll('.cselect__opt'));
      const active = document.activeElement;

      if (e.key === 'Escape') {
        e.preventDefault();
        close();
        btn.focus();
        return;
      }

      // If menu container is focused, ArrowDown focuses first option
      if (active === menu && (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ')) {
        e.preventDefault();
        const first = items[0];
        first && first.focus();
        return;
      }

      const idx = items.indexOf(active);
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        const next = items[Math.min(items.length - 1, idx + 1)] || items[0];
        next && next.focus();
        return;
      }
      if (e.key === 'ArrowUp') {
        e.preventDefault();
        const prev = items[Math.max(0, idx - 1)] || items[0];
        prev && prev.focus();
        return;
      }
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        if (active && active.dataset && active.dataset.value) {
          setValue(active.dataset.value);
          close();
          btn.focus();
        }
      }
    });

    document.addEventListener('click', (e) => {
      if (!root.contains(e.target)) close();
    });
  }

  document.querySelectorAll('.cselect[data-select]').forEach(initCustomSelect);
})();</script></body>
</html>
